<div *ngIf="!isLoading" class="container mx-auto px-6 py-10 bg-gray-50 min-h-screen">
  <!-- En-tête avec recherche et action principale -->
  <div class="mb-8 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
    <div class="space-y-2">
      <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Gestion des Utilisateurs</h1>
      <div class="flex items-center gap-2 text-sm text-gray-500">
        <mat-icon class="text-gray-400 text-base">group</mat-icon>
        <span>{{ mentors.length }} mentors enregistrés</span>
      </div>
    </div>
    <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
      <!-- Barre de recherche -->
      <div class="relative w-full sm:w-64 lg:w-72">
        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
          <mat-icon class="text-gray-400 text-lg">search</mat-icon>
        </div>
        <input
          type="search"
          [(ngModel)]="searchText"
          (input)="applyFilter()"
          class="bg-white w-full pl-10 pr-4 py-3 rounded-lg border border-gray-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-sm outline-none transition-all"
          placeholder="Rechercher un mentor...">
      </div>
      <!-- Bouton d'ajout -->
      <button
        mat-raised-button
        color="primary"
        class="h-12 px-6 flex items-center gap-2 rounded-lg shadow-md hover:shadow-lg transition-all"
        (click)="addMentor()">
        <mat-icon>person_add</mat-icon>
        <span class="font-medium">Nouvel utilisateur</span>
      </button>
    </div>
  </div>

  <!-- Statistiques résumé -->
  <div class="mb-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
    <!-- Carte Total Users -->
    <div class="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 border border-gray-100 flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <div class="bg-blue-100 p-3 rounded-full">
          <mat-icon class="text-blue-600">people</mat-icon>
        </div>
        <span class="text-xs font-medium text-blue-600 bg-blue-50 px-2 py-1 rounded-full">Total</span>
      </div>
      <p class="text-3xl font-bold text-gray-900 mb-1">{{ mentors.length }}</p>
      <p class="text-sm text-gray-500">Utilisateurs</p>
    </div>

    <!-- Carte Active Users -->
    <div class="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 border border-gray-100 flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <div class="bg-green-100 p-3 rounded-full">
          <mat-icon class="text-green-600">check_circle</mat-icon>
        </div>
        <span class="text-xs font-medium text-green-600 bg-green-50 px-2 py-1 rounded-full">Actifs</span>
      </div>
      <p class="text-3xl font-bold text-gray-900 mb-1">{{ getActiveUsersCount() }}</p>
      <p class="text-sm text-gray-500">Utilisateurs actifs</p>
    </div>

    <!-- Carte Nouveaux -->
    <div class="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 border border-gray-100 flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <div class="bg-purple-100 p-3 rounded-full">
          <mat-icon class="text-purple-600">trending_up</mat-icon>
        </div>
        <span class="text-xs font-medium text-purple-600 bg-purple-50 px-2 py-1 rounded-full">+{{ 7 }}%</span>
      </div>
      <p class="text-3xl font-bold text-gray-900 mb-1">{{ getNewUsersCount() }}</p>
      <p class="text-sm text-gray-500">Nouveaux (7j)</p>
    </div>

    <!-- Carte Taux moyen -->
    <div class="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition-all duration-300 border border-gray-100 flex flex-col">
      <div class="flex items-center justify-between mb-4">
        <div class="bg-amber-100 p-3 rounded-full">
          <mat-icon class="text-amber-600">euro</mat-icon>
        </div>
        <span class="text-xs font-medium text-amber-600 bg-amber-50 px-2 py-1 rounded-full">Moyenne</span>
      </div>
      <p class="text-3xl font-bold text-gray-900 mb-1">{{ 3454.0 | number:'1.1-1' }}€</p>
      <p class="text-sm text-gray-500">Taux horaire</p>
    </div>
  </div>

  <!-- Filtres rapides avant le tableau -->
<!--  <div class="mb-6 flex flex-wrap gap-3">-->
<!--    <button-->
<!--      class="px-4 py-2 rounded-lg shadow-sm transition-colors flex items-center gap-1"-->
<!--      [ngClass]="selectedFilter === 'ALL' ? 'bg-blue-500 text-white' : 'bg-white text-gray-700 border border-gray-200 hover:bg-gray-50'"-->
<!--      (click)="filterBy('ALL')">-->
<!--      <mat-icon class="text-sm">filter_list</mat-icon>-->
<!--      <span>Tous</span>-->
<!--    </button>-->
<!--    <button-->
<!--      class="px-4 py-2 rounded-lg shadow-sm transition-colors flex items-center gap-1 border"-->
<!--      [ngClass]="selectedFilter === 'ACTIVE' ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-700 border-gray-200 hover:bg-gray-50'"-->
<!--      (click)="filterBy('ACTIVE')">-->
<!--      <mat-icon class="text-sm">check_circle</mat-icon>-->
<!--      <span>Actifs</span>-->
<!--    </button>-->
<!--    <button-->
<!--      class="px-4 py-2 rounded-lg shadow-sm transition-colors flex items-center gap-1 border"-->
<!--      [ngClass]="selectedFilter === 'INACTIVE' ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-700 border-gray-200 hover:bg-gray-50'"-->
<!--      (click)="filterBy('INACTIVE')">-->
<!--      <mat-icon class="text-sm">cancel</mat-icon>-->
<!--      <span>Inactifs</span>-->
<!--    </button>-->
<!--    <button-->
<!--      class="px-4 py-2 rounded-lg shadow-sm transition-colors flex items-center gap-1 border"-->
<!--      [ngClass]="selectedFilter === 'MENTOR' ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-700 border-gray-200 hover:bg-gray-50'"-->
<!--      (click)="filterBy('MENTOR')">-->
<!--      <mat-icon class="text-sm">school</mat-icon>-->
<!--      <span>Mentors</span>-->
<!--    </button>-->
<!--    <button-->
<!--      class="px-4 py-2 rounded-lg shadow-sm transition-colors flex items-center gap-1 border"-->
<!--      [ngClass]="selectedFilter === 'CONSULTANT' ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-700 border-gray-200 hover:bg-gray-50'"-->
<!--      (click)="filterBy('CONSULTANT')">-->
<!--      <mat-icon class="text-sm">work</mat-icon>-->
<!--      <span>Consultants</span>-->
<!--    </button>-->
<!--  </div>-->

  <!-- Tableau responsive avec design moderne -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    <table mat-table [dataSource]="dataSource" matSort class="w-full">
      <!-- En-têtes de colonnes améliorées -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef class="pl-6 pr-2 py-4">
          <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</span>
        </th>
        <td mat-cell *matCellDef="let user" class="pl-6 pr-2 py-4" (click)="$event.stopPropagation()">
          <div class="flex items-center gap-2">
            <div class="relative">
              <div class="absolute -left-1 top-1/2 -translate-y-1/2 w-2 h-2 rounded-full animate-pulse"
                   [ngClass]="user.actif ? 'bg-green-500' : 'bg-red-500'"></div>
              <mat-icon
                class="text-gray-400 hover:text-gray-600 cursor-pointer transition-colors"
                [matTooltip]="user.actif ? 'Actif' : 'Inactif'"
                (click)="toggleUserStatus(user)">
                {{ user.actif ? 'toggle_on' : 'toggle_off' }}
              </mat-icon>
            </div>
          </div>
        </td>
      </ng-container>

      <!-- Colonne Utilisateur avec hover state -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="px-4 py-4">
          <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Utilisateur</span>
        </th>
        <td mat-cell *matCellDef="let user" class="px-4 py-4 group">
          <div class="flex items-center gap-3 cursor-pointer transition-transform hover:-translate-x-1">
            <div class="relative">
              <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white font-medium shadow-md">
                {{ user?.prenom?.charAt(0) || '' }}{{ user?.nom?.charAt(0) || '' }}
              </div>
              <div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 rounded-full border-2 border-white"
                   [ngClass]="user.actif ? 'bg-green-500' : 'bg-red-500'"></div>
            </div>
            <div>
              <div class="font-medium text-gray-900 group-hover:text-blue-600 transition-colors">
                {{ user.prenom | titlecase }} {{ user.nom | titlecase }}
              </div>
              <div class="text-sm text-gray-500 flex items-center gap-1.5 mt-0.5">
                <mat-icon class="text-gray-400 !text-[16px]">alternate_email</mat-icon>
                <span class="truncate max-w-[160px]">{{ user.email }}</span>
              </div>
            </div>
          </div>
        </td>
      </ng-container>

      <!-- Colonne Rôle avec design cohérent -->
      <ng-container matColumnDef="role">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="px-4 py-4">
          <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Rôle</span>
        </th>
        <td mat-cell *matCellDef="let user" class="px-4 py-4">
          <span [ngClass]="{
            'bg-blue-100/80 text-blue-800': user.roles === 'MENTOR',
            'bg-purple-100/80 text-purple-800': user.roles === 'CONSULTANT',
            'bg-amber-100/80 text-amber-800': user.roles === 'VALIDATOR'
          }" class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium border border-transparent hover:border-current transition-all">
            <mat-icon class="!text-[16px] !w-4 !h-4">
              {{ getRoleIcon(user.roles) }}
            </mat-icon>
            {{ user.roles }}
          </span>
        </td>
      </ng-container>

      <!-- Colonne Qualifications avec tooltip -->
      <ng-container matColumnDef="qualifications">
        <th mat-header-cell *matHeaderCellDef class="px-4 py-4">
          <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Compétences</span>
        </th>
        <td mat-cell *matCellDef="let user" class="px-4 py-4">
          <div class="flex flex-wrap gap-1.5 max-w-[240px]" [matTooltip]="user.qualifications?.join(', ') || ''">
            <span *ngFor="let qual of user.qualifications?.slice(0,2) || []"
                  class="px-2.5 py-1 bg-gray-100 border border-gray-200 rounded-full text-xs text-gray-700 truncate">
              {{ qual }}
            </span>
            <span *ngIf="user.qualifications?.length > 2"
                  class="px-2.5 py-1 bg-gray-200 rounded-full text-xs text-gray-700 font-medium">
              +{{ user.qualifications.length - 2 }}
            </span>
          </div>
        </td>
      </ng-container>

      <!-- Colonne Taux avec mise en valeur -->
      <ng-container matColumnDef="rate">
        <th mat-header-cell *matHeaderCellDef mat-sort-header class="px-4 py-4">
          <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Taux</span>
        </th>
        <td mat-cell *matCellDef="let user" class="px-4 py-4 text-right">
          <div class="inline-flex items-center gap-1.5 bg-green-50/50 px-3 py-1.5 rounded-lg border border-green-100">
            <span class="text-base font-medium text-green-700">
              {{ user.hourlyRate | number:'1.1-1' }}€
            </span>
            <mat-icon class="text-green-600 !text-[18px]">trending_up</mat-icon>
          </div>
        </td>
      </ng-container>

      <!-- Colonne Actions avec menu contextuel amélioré -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="pr-6 py-4 text-right">
          <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</span>
        </th>
        <td mat-cell *matCellDef="let user" class="pr-6 py-4" (click)="$event.stopPropagation()">
          <div class="flex justify-end">
            <button mat-icon-button [matMenuTriggerFor]="menu"
                    class="hover:bg-gray-100 rounded-lg text-gray-500 hover:text-gray-700 transition-colors">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #menu="matMenu" class="shadow-xl rounded-xl overflow-hidden min-w-[200px] border border-gray-100">
              <button mat-menu-item (click)="viewDetails(user)" class="flex items-center gap-3 h-12">
                <mat-icon class="text-gray-500">visibility</mat-icon>
                <span class="text-sm">Détails</span>
              </button>
              <button mat-menu-item (click)="editUser(user)" class="flex items-center gap-3 h-12">
                <mat-icon class="text-blue-500">edit</mat-icon>
                <span class="text-sm">Modifier</span>
              </button>
              <mat-divider class="my-1"></mat-divider>
              <button mat-menu-item (click)="toggleUserStatus(user)" class="flex items-center gap-3 h-12">
                <mat-icon [color]="user.actif ? 'warn' : 'primary'">
                  {{ user.actif ? 'toggle_off' : 'toggle_on' }}
                </mat-icon>
                <span class="text-sm">{{ user.actif ? 'Désactiver' : 'Activer' }}</span>
              </button>
              <button mat-menu-item (click)="confirmDelete(user)" class="flex items-center gap-3 h-12 text-red-600">
                <mat-icon>delete</mat-icon>
                <span class="text-sm">Supprimer</span>
              </button>
            </mat-menu>
          </div>
        </td>
      </ng-container>

      <!-- Lignes avec hover state amélioré -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns" class="bg-gray-50 border-b border-gray-200"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"
          class="hover:bg-blue-50/20 transition-colors border-b border-gray-100 cursor-pointer"
          (click)="viewDetails(row)"></tr>

      <!-- État vide moderne -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell py-16 text-center" [attr.colspan]="displayedColumns.length">
          <div class="max-w-md mx-auto space-y-6">
            <div class="text-blue-100/50 mx-auto animate-float">
              <mat-icon class="text-7xl">auto_awesome</mat-icon>
            </div>
            <h3 class="text-xl font-semibold text-gray-900">Commencez à collaborer</h3>
            <p class="text-gray-500 px-8">
              Aucun mentor trouvé. Ajoutez votre premier collaborateur pour commencer.
            </p>
            <button mat-raised-button color="primary"
                    class="!h-12 !rounded-xl shadow-md hover:shadow-lg transition-all"
                    (click)="addMentor()">
              <mat-icon>add_circle</mat-icon>
              Ajouter un mentor
            </button>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <!-- Pagination modernisée -->
  <div class="mt-6 flex flex-col sm:flex-row justify-between items-center bg-white rounded-lg shadow-sm border border-gray-200 p-4">
    <div class="text-sm text-gray-500 mb-4 sm:mb-0">
      Affichage de <span class="font-medium text-gray-700">{{ dataSource.filteredData.length || 0 }}</span> sur <span class="font-medium text-gray-700">{{ totalUsers }}</span> utilisateurs
    </div>
    <mat-paginator
      [length]="totalUsers"
      [pageSize]="pageSize"
      [pageSizeOptions]="[10, 25, 50]"
      (page)="onPageChange($event)"
      aria-label="Sélectionner une page"
      class="!shadow-none !border-0">
    </mat-paginator>
  </div>
</div>
