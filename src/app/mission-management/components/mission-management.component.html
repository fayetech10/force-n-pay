<!-- missions.component.html -->

<div *ngIf="isLoading"
    class="fixed inset-0 z-50 bg-white/95 dark:bg-gray-900/95 backdrop-blur-sm flex items-center justify-center transition-opacity"
    role="status" aria-live="polite">
    <div class="flex flex-col items-center gap-3 animate-fade-in">
        <div class="relative w-16 h-16">
            <div class="absolute inset-0 border-4 border-blue-200/30 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-blue-500 border-t-transparent rounded-full animate-spin-slow">
            </div>
        </div>
        <span class="text-gray-600 dark:text-gray-300 font-medium animate-pulse">
            Chargement des missions...
        </span>
    </div>
</div>

<div class="container mx-auto">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold mb-2">Gestion des Missions</h1>
            <p class="text-gray-600 dark:text-gray-400">Gérez et suivez toutes les missions disponibles</p>
        </div>
        <button mat-flat-button color="primary" class="rounded-lg" (click)="openMissionDialog()">
            <mat-icon class="mr-2">add</mat-icon> Nouvelle Mission
        </button>
    </div>

    <!-- Graphique des missions -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <mat-card class="rounded-xl shadow-sm p-6">
            <h2 class="text-lg font-bold mb-4">État des Missions</h2>
            <div class="h-64">
                <canvas baseChart [data]="missionChartData" [type]="'doughnut'" [options]="chartOptions">
                </canvas>
            </div>
            <div class="grid grid-cols-3 text-center mt-4">
                <div>
                    <div class="text-lg font-bold">25</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">En cours</div>
                </div>
                <div>
                    <div class="text-lg font-bold">12</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">Terminées</div>
                </div>
                <div>
                    <div class="text-lg font-bold">5</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">En attente</div>
                </div>
            </div>
        </mat-card>

        <mat-card class="rounded-xl shadow-sm p-6">
            <h2 class="text-lg font-bold mb-4">Progression Mensuelle</h2>
            <div class="h-64">
                <canvas baseChart [data]="progressChartData" [type]="'bar'" [options]="barChartOptions">
                </canvas>
            </div>
        </mat-card>

        <mat-card class="rounded-xl shadow-sm p-6">
            <h2 class="text-lg font-bold mb-4">Répartition par Type</h2>
            <div class="h-64">
                <canvas baseChart [data]="typeChartData" [type]="'pie'" [options]="chartOptions">
                </canvas>
            </div>
        </mat-card>
    </div>
    <!-- Filtres et recherche -->

    <!-- Tableau des missions -->
    <mat-card class="rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 bg-white dark:bg-gray-800">
        <!-- En-tête avec titre et filtre -->
        <div
            class="p-4 border-b border-gray-100 dark:border-gray-700 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200">Gestion des missions</h2>

            <!-- Champ de recherche -->
            <div class="relative w-full sm:w-64">
                <input type="text" [(ngModel)]="filter" placeholder="Rechercher..." class="w-full pl-10 pr-4 py-2 rounded-lg bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 
                              focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent
                              text-sm transition-all duration-300" (input)="applyFilter()">
                <mat-icon class="absolute left-3 top-2.5 text-gray-400 dark:text-gray-500 text-sm">search</mat-icon>
            </div>
        </div>

        <!-- Tableau -->
        <div class="overflow-x-auto">
            <table mat-table [dataSource]="filteredMissions" class="w-full" aria-label="Liste des missions" matSort>

                <!-- Colonnes -->
                <!-- ID Column -->
                <ng-container matColumnDef="id">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400">ID</th>
                    <td mat-cell *matCellDef="let mission"
                        class="px-6 py-4 text-sm text-gray-700 dark:text-gray-300 font-mono">{{ mission.id }}</td>
                </ng-container>

                <!-- Name Column -->
                <ng-container matColumnDef="name">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400">Nom</th>
                    <td mat-cell *matCellDef="let mission" class="px-6 py-4">
                        <div class="font-medium text-gray-900 dark:text-gray-100">{{ mission.name }}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mt-1 line-clamp-2">
                            {{ mission.description || 'Aucune description' | truncate:60 }}
                        </div>
                    </td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400">Statut</th>
                    <td mat-cell *matCellDef="let mission" class="px-6 py-4">
                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full transition-colors 
                                  {{ getStatusClass(mission.status_mission) }}">
                            {{ mission.status_mission }}
                        </span>
                    </td>
                </ng-container>

                <!-- Assignee Column -->
                <ng-container matColumnDef="assignee">
                    <th mat-header-cell *matHeaderCellDef
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400">Assigné à</th>
                    <td mat-cell *matCellDef="let mission" class="px-6 py-4">
                        <div class="flex items-center group">
                            <div class="h-8 w-8 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center 
                                     mr-2 transition-colors group-hover:bg-blue-200 dark:group-hover:bg-blue-900/50">
                                <span *ngIf="!mission?.utilisateur?.avatar"
                                    class="text-sm font-medium text-blue-600 dark:text-blue-300">
                                    {{ mission?.utilisateur?.nom?.charAt(0) | uppercase }}
                                </span>
                                <img *ngIf="mission?.utilisateur?.avatar" [src]="mission.utilisateur.avatar"
                                    class="h-full w-full rounded-full object-cover">
                            </div>
                            <span class="text-sm text-gray-700 dark:text-gray-300">{{ mission?.utilisateur?.nom |
                                titlecase
                                }}</span>
                        </div>
                    </td>
                </ng-container>

                <!-- Dates Columns -->
                <ng-container matColumnDef="startDate">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400">Début</th>
                    <td mat-cell *matCellDef="let mission" class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                        {{ mission.dateDebut | date: 'dd/MM/yy' }}
                    </td>
                </ng-container>

                <ng-container matColumnDef="endDate">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400">Fin</th>
                    <td mat-cell *matCellDef="let mission" class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">
                        {{ mission.dateFin ? (mission.dateFin | date: 'dd/MM/yy') : '-' }}
                    </td>
                </ng-container>

                <!-- Progress Column -->
                <ng-container matColumnDef="progress">
                    <th mat-header-cell *matHeaderCellDef
                        class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400">Progression
                    </th>
                    <td mat-cell *matCellDef="let mission" class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mr-3">
                                <div class="h-2.5 rounded-full transition-all duration-500 {{ getProgressBarClass(mission) }}"
                                    [style.width.%]="mission.progress">
                                </div>
                            </div>
                            <span class="text-xs font-medium {{ getProgressTextClass(mission) }}">
                                {{ mission.progress }}%
                            </span>
                        </div>
                    </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef
                        class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400">Actions</th>
                    <td mat-cell *matCellDef="let mission" class="px-6 py-4 text-right">
                        <button mat-icon-button [matMenuTriggerFor]="actionMenu"
                            class="hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
                            <mat-icon class="text-gray-400 dark:text-gray-300">more_vert</mat-icon>
                        </button>
                        <mat-menu #actionMenu="matMenu"
                            class="min-w-[160px] bg-white/95 dark:bg-gray-800 backdrop-blur-md shadow-xl">
                            <button mat-menu-item (click)="editMission(mission)" class="h-10">
                                <mat-icon class="text-gray-500 mr-2">edit</mat-icon>
                                <span>Modifier</span>
                            </button>
                            <button mat-menu-item (click)="viewMissionDetails(mission)" class="h-10">
                                <mat-icon class="text-gray-500 mr-2">visibility</mat-icon>
                                <span>Détails</span>
                            </button>
                            <button mat-menu-item (click)="downloadReport(mission)" class="h-10">
                                <mat-icon class="text-gray-500 mr-2">download</mat-icon>
                                <span>Télécharger</span>
                            </button>
                            <div class="border-t border-gray-100 dark:border-gray-700 my-1"></div>
                            <button mat-menu-item (click)="deleteMission(mission)"
                                class="h-10 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20">
                                <mat-icon class="mr-2">delete</mat-icon>
                                <span>Supprimer</span>
                            </button>
                        </mat-menu>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"
                    class="hover:bg-gray-50 dark:hover:bg-gray-700/10 transition-colors border-t border-gray-100 dark:border-gray-700">
                </tr>
            </table>
        </div>

        <!-- Pagination -->
        <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" showFirstLastButtons
            class="border-t border-gray-100 dark:border-gray-700 [&_.mat-mdc-paginator-range-actions]:gap-2"
            [pageSize]="5" aria-label="Sélectionner une page">
        </mat-paginator>

        <!-- Message quand aucun résultat -->
        <div *ngIf="filteredMissions.length === 0" class="p-8 text-center text-gray-500 dark:text-gray-400">
            <mat-icon class="text-4xl mb-4">search_off</mat-icon>
            <p class="font-medium">Aucune mission trouvée</p>
            <p class="text-sm mt-1">Essayez d'autres termes de recherche</p>
        </div>
    </mat-card>
</div>

<ng-template #missionDialog>
    <div class="p-0 w-full max-h-[95vh] overflow-auto">
        <!-- Header with gradient background -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-700 p-6 rounded-t-lg">
            <h2 class="text-2xl font-bold text-white">
                {{ editMode ? 'Modifier la Mission' : 'Nouvelle Mission' }}
            </h2>
            <p class="text-blue-100 mt-1">Remplissez les informations ci-dessous</p>
        </div>

        <form [formGroup]="missionForm" (ngSubmit)="saveMission()" class="p-6">
            <!-- Form sections -->
            <div class="mb-8">
                <h3 class="text-lg font-medium text-gray-700 mb-4 pb-2 border-b">Informations générales</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Nom -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Nom de la Mission</mat-label>
                        <input matInput formControlName="name" required>
                        <mat-icon matPrefix class="text-gray-400 mr-2">assignment</mat-icon>
                        <mat-error *ngIf="missionForm.get('name')?.hasError('required')">
                            Champ obligatoire
                        </mat-error>
                    </mat-form-field>

                    <!-- Statut -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Statut</mat-label>
                        <mat-select formControlName="status_mission" required>
                            <mat-option *ngFor="let status of statusOptions" [value]="status">
                                {{status}}
                            </mat-option>
                        </mat-select>
                        <mat-icon matPrefix class="text-gray-400 mr-2">flag</mat-icon>
                    </mat-form-field>

                    <!-- Type -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Type</mat-label>
                        <mat-select formControlName="type" required>
                            <mat-option *ngFor="let type of typeOptions" [value]="type">
                                {{type}}
                            </mat-option>
                        </mat-select>
                        <mat-icon matPrefix class="text-gray-400 mr-2">category</mat-icon>
                    </mat-form-field>

                    <!-- Assigné à -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Assigné à</mat-label>
                        <mat-select formControlName="utilisateur" required>
                            <mat-option *ngFor="let user of users" [value]="user">
                                {{ user.nom }}
                            </mat-option>
                        </mat-select>
                        <mat-icon matPrefix class="text-gray-400 mr-2">person</mat-icon>
                    </mat-form-field>
                </div>
            </div>

            <div class="mb-8">
                <h3 class="text-lg font-medium text-gray-700 mb-4 pb-2 border-b">Détails & Planning</h3>

                <div class="grid grid-cols-1 gap-6">
                    <!-- Description -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Description</mat-label>
                        <textarea matInput formControlName="description" rows="3"></textarea>
                        <mat-icon matPrefix class="text-gray-400 mr-2">description</mat-icon>
                    </mat-form-field>

                    <!-- Objectif -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Objectif</mat-label>
                        <textarea matInput formControlName="objectif" rows="3"></textarea>
                        <mat-icon matPrefix class="text-gray-400 mr-2">track_changes</mat-icon>
                    </mat-form-field>
                </div>
            </div>

            <div class="mb-8">
                <h3 class="text-lg font-medium text-gray-700 mb-4 pb-2 border-b">Planning & Budget</h3>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Dates -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Date de début</mat-label>
                        <input matInput [matDatepicker]="startPicker" formControlName="dateDebut" required>
                        <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                        <mat-datepicker #startPicker></mat-datepicker>
                        <mat-icon matPrefix class="text-gray-400 mr-2">event</mat-icon>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Date de fin</mat-label>
                        <input matInput [matDatepicker]="endPicker" formControlName="dateFin">
                        <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
                        <mat-datepicker #endPicker></mat-datepicker>
                        <mat-icon matPrefix class="text-gray-400 mr-2">event_busy</mat-icon>
                    </mat-form-field>

                    <!-- Budget -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Budget (€)</mat-label>
                        <input matInput type="number" formControlName="budget" min="0">
                        <mat-icon matPrefix class="text-gray-400 mr-2">euro_symbol</mat-icon>
                        <span matSuffix>€</span>
                    </mat-form-field>
                </div>
            </div>

            <!-- Actions - sticky footer -->
            <div class="sticky bottom-0 left-0 right-0 p-4 bg-white border-t mt-8 flex justify-end gap-4">
                <button mat-stroked-button type="button" mat-dialog-close class="px-6">
                    <mat-icon>close</mat-icon>
                    Annuler
                </button>
                <button mat-raised-button color="primary" type="submit" [disabled]="missionForm.invalid" class="px-6">
                    <mat-icon>{{ editMode ? 'save' : 'add' }}</mat-icon>
                    {{ editMode ? 'Mettre à jour' : 'Créer' }}
                </button>
            </div>
        </form>
    </div>
</ng-template>