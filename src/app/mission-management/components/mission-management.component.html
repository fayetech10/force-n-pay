<!-- missions.component.html -->

<div *ngIf="isLoading" class="fixed inset-0 flex justify-center items-center bg-gray-300 bg-opacity-75">
    <mat-spinner color="primary"></mat-spinner>
</div>

<div class="container mx-auto" *ngIf="!isLoading">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold mb-2">Gestion des Missions</h1>
            <p class="text-gray-600 dark:text-gray-400">Gérez et suivez toutes les missions disponibles</p>
        </div>
        <button mat-flat-button color="primary" class="rounded-lg" (click)="openMissionDialog()">
            <mat-icon class="mr-2">add</mat-icon> Nouvelle Mission
        </button>
    </div>

    <!-- Graphique des missions -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
        <mat-card class="rounded-xl shadow-sm p-6">
            <h2 class="text-lg font-bold mb-4">État des Missions</h2>
            <div class="h-64">
                <canvas baseChart [data]="missionChartData" [type]="'doughnut'" [options]="chartOptions">
                </canvas>
            </div>
            <div class="grid grid-cols-3 text-center mt-4">
                <div>
                    <div class="text-lg font-bold">25</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">En cours</div>
                </div>
                <div>
                    <div class="text-lg font-bold">12</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">Terminées</div>
                </div>
                <div>
                    <div class="text-lg font-bold">5</div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">En attente</div>
                </div>
            </div>
        </mat-card>

        <mat-card class="rounded-xl shadow-sm p-6">
            <h2 class="text-lg font-bold mb-4">Progression Mensuelle</h2>
            <div class="h-64">
                <canvas baseChart [data]="progressChartData" [type]="'bar'" [options]="barChartOptions">
                </canvas>
            </div>
        </mat-card>

        <mat-card class="rounded-xl shadow-sm p-6">
            <h2 class="text-lg font-bold mb-4">Répartition par Type</h2>
            <div class="h-64">
                <canvas baseChart [data]="typeChartData" [type]="'pie'" [options]="chartOptions">
                </canvas>
            </div>
        </mat-card>
    </div>
    <!-- Filtres et recherche -->
    <mat-card class="rounded-xl shadow-sm mb-6">
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <mat-form-field class="w-full">
                    <mat-label>Rechercher</mat-label>
                    <input matInput placeholder="Nom, ID, utilisateur..." [(ngModel)]="searchQuery">
                    <mat-icon matSuffix>search</mat-icon>
                </mat-form-field>

                <mat-form-field class="w-full">
                    <mat-label>Statut</mat-label>
                    <mat-select [(ngModel)]="filterStatus">
                        <mat-option value="">Tous</mat-option>
                        <mat-option *ngFor="let status of statusOptions" [value]="status">
                            {{ status }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>

                <mat-form-field class="w-full">
                    <mat-label>Date</mat-label>
                    <input matInput [matDatepicker]="picker" placeholder="Choisir une date">
                    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                    <mat-datepicker #picker></mat-datepicker>
                </mat-form-field>

                <div class="flex items-center space-x-2">
                    <button mat-stroked-button class="flex-1">
                        <mat-icon>filter_list</mat-icon> Filtrer
                    </button>
                    <button mat-stroked-button class="flex-1">
                        <mat-icon>refresh</mat-icon> Réinitialiser
                    </button>
                </div>
            </div>
        </div>
    </mat-card>
    <!-- Tableau des missions -->
    <mat-card class="rounded-xl shadow-sm">
        <div class="overflow-x-auto">
            <table mat-table [dataSource]="missions" class="w-full" aria-label="Liste des missions">

                <!-- ID Column -->
                <ng-container matColumnDef="id">
                    <th mat-header-cell *matHeaderCellDef class="px-6 py-3 text-left text-xs font-medium">ID</th>
                    <td mat-cell *matCellDef="let mission" class="px-6 py-4">{{ mission.id }}</td>
                </ng-container>

                <!-- Name Column -->
                <ng-container matColumnDef="name">
                    <th mat-header-cell *matHeaderCellDef class="px-6 py-3 text-left text-xs font-medium">Nom</th>
                    <td mat-cell *matCellDef="let mission" class="px-6 py-4">
                        <div class="font-medium">{{ mission.name }}</div>
                        <div class="text-xs text-gray-500">
                            {{ (mission.description | slice:0:60) || 'Aucune description' }}{{
                            mission.description?.length >
                            60 ? '...' : '' }}
                        </div>
                    </td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef class="px-6 py-3 text-left text-xs font-medium">Statut</th>
                    <td mat-cell *matCellDef="let mission" class="px-6 py-4">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full" [ngClass]="{
                  'bg-green-100 text-green-800': mission.status_mission === 'Termine',
                  'bg-blue-100 text-blue-800': mission.status_mission === 'En Cour',
                  'bg-gray-100 text-gray-800': mission.status_mission === 'En attente'
                }">
                            {{ mission.status_mission }}
                        </span>
                    </td>
                </ng-container>

                <!-- Assignee Column -->
                <ng-container matColumnDef="assignee">
                    <th mat-header-cell *matHeaderCellDef class="px-6 py-3 text-left text-xs font-medium">Assigné à</th>
                    <td mat-cell *matCellDef="let mission" class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center mr-2">
                                <mat-icon class="text-sm" aria-hidden="true">person</mat-icon>
                            </div>
                            <span>{{ mission?.utilisateur?.nom | titlecase }}</span>
                        </div>
                    </td>
                </ng-container>

                <!-- Dates Columns -->
                <ng-container matColumnDef="startDate">
                    <th mat-header-cell *matHeaderCellDef class="px-6 py-3 text-left text-xs font-medium">Date de début
                    </th>
                    <td mat-cell *matCellDef="let mission" class="px-6 py-4">
                        {{ mission.dateDebut | date: 'dd/MM/yyyy' }}
                    </td>
                </ng-container>

                <ng-container matColumnDef="endDate">
                    <th mat-header-cell *matHeaderCellDef class="px-6 py-3 text-left text-xs font-medium">Date de fin
                    </th>
                    <td mat-cell *matCellDef="let mission" class="px-6 py-4">
                        {{ (mission.dateFin | date: 'dd/MM/yyyy') || '-' }}
                    </td>
                </ng-container>

                <!-- Progress Column -->
                <ng-container matColumnDef="progress">
                    <th mat-header-cell *matHeaderCellDef class="px-6 py-3 text-left text-xs font-medium">Progression
                    </th>
                    <td mat-cell *matCellDef="let mission" class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                                <div class="h-2 rounded-full" [style.width.%]="mission.progress" [ngClass]="{
                     'bg-blue-500': mission.status_mission === 'En Cour',
                     'bg-green-500': mission.status_mission === 'Termine',
                     'bg-gray-400': mission.status_mission === 'En attente'
                   }">
                                </div>
                            </div>
                            <span class="text-sm">{{ mission.progress }}%</span>
                        </div>
                    </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef class="px-6 py-3 text-right text-xs font-medium">Actions</th>
                    <td mat-cell *matCellDef="let mission" class="px-6 py-4 text-right">
                        <button mat-icon-button [matMenuTriggerFor]="actionMenu" aria-label="Menu des actions">
                            <mat-icon>more_vert</mat-icon>
                        </button>
                        <mat-menu #actionMenu="matMenu">
                            <button mat-menu-item (click)="editMission(mission)">
                                <mat-icon role="img" aria-hidden="false">edit</mat-icon>
                                <span>Modifier</span>
                            </button>
                            <button mat-menu-item (click)="viewMissionDetails(mission)">
                                <mat-icon>visibility</mat-icon>
                                <span>Voir Détails</span>
                            </button>
                            <button mat-menu-item (click)="downloadReport(mission)">
                                <mat-icon>download</mat-icon>
                                <span>Télécharger Rapport</span>
                            </button>
                            <button mat-menu-item (click)="deleteMission(mission)" class="text-red-500">
                                <mat-icon>delete</mat-icon>
                                <span>Supprimer</span>
                            </button>
                        </mat-menu>
                    </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"
                    class="hover:bg-gray-50 transition-colors cursor-pointer">
                </tr>
            </table>
        </div>

        <!-- Pagination -->
        <mat-paginator [pageSizeOptions]="[5, 10, 25, 100]" showFirstLastButtons aria-label="Sélectionner une page"
            class="border-t border-gray-200">
        </mat-paginator>
    </mat-card>
</div>

<ng-template #missionDialog>
    <div class="p-0 w-full max-h-[95vh] overflow-auto">
        <!-- Header with gradient background -->
        <div class="bg-gradient-to-r from-blue-600 to-indigo-700 p-6 rounded-t-lg">
            <h2 class="text-2xl font-bold text-white">
                {{ editMode ? 'Modifier la Mission' : 'Nouvelle Mission' }}
            </h2>
            <p class="text-blue-100 mt-1">Remplissez les informations ci-dessous</p>
        </div>

        <form [formGroup]="missionForm" (ngSubmit)="saveMission()" class="p-6">
            <!-- Form sections -->
            <div class="mb-8">
                <h3 class="text-lg font-medium text-gray-700 mb-4 pb-2 border-b">Informations générales</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Nom -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Nom de la Mission</mat-label>
                        <input matInput formControlName="name" required>
                        <mat-icon matPrefix class="text-gray-400 mr-2">assignment</mat-icon>
                        <mat-error *ngIf="missionForm.get('name')?.hasError('required')">
                            Champ obligatoire
                        </mat-error>
                    </mat-form-field>

                    <!-- Statut -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Statut</mat-label>
                        <mat-select formControlName="status_mission" required>
                            <mat-option *ngFor="let status of statusOptions" [value]="status">
                                {{status}}
                            </mat-option>
                        </mat-select>
                        <mat-icon matPrefix class="text-gray-400 mr-2">flag</mat-icon>
                    </mat-form-field>

                    <!-- Type -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Type</mat-label>
                        <mat-select formControlName="type" required>
                            <mat-option *ngFor="let type of typeOptions" [value]="type">
                                {{type}}
                            </mat-option>
                        </mat-select>
                        <mat-icon matPrefix class="text-gray-400 mr-2">category</mat-icon>
                    </mat-form-field>

                    <!-- Assigné à -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Assigné à</mat-label>
                        <mat-select formControlName="utilisateur" required>
                            <mat-option *ngFor="let user of users" [value]="user">
                                {{ user.nom }}
                            </mat-option>
                        </mat-select>
                        <mat-icon matPrefix class="text-gray-400 mr-2">person</mat-icon>
                    </mat-form-field>
                </div>
            </div>

            <div class="mb-8">
                <h3 class="text-lg font-medium text-gray-700 mb-4 pb-2 border-b">Détails & Planning</h3>

                <div class="grid grid-cols-1 gap-6">
                    <!-- Description -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Description</mat-label>
                        <textarea matInput formControlName="description" rows="3"></textarea>
                        <mat-icon matPrefix class="text-gray-400 mr-2">description</mat-icon>
                    </mat-form-field>

                    <!-- Objectif -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Objectif</mat-label>
                        <textarea matInput formControlName="objectif" rows="3"></textarea>
                        <mat-icon matPrefix class="text-gray-400 mr-2">track_changes</mat-icon>
                    </mat-form-field>
                </div>
            </div>

            <div class="mb-8">
                <h3 class="text-lg font-medium text-gray-700 mb-4 pb-2 border-b">Planning & Budget</h3>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Dates -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Date de début</mat-label>
                        <input matInput [matDatepicker]="startPicker" formControlName="dateDebut" required>
                        <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                        <mat-datepicker #startPicker></mat-datepicker>
                        <mat-icon matPrefix class="text-gray-400 mr-2">event</mat-icon>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Date de fin</mat-label>
                        <input matInput [matDatepicker]="endPicker" formControlName="dateFin">
                        <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
                        <mat-datepicker #endPicker></mat-datepicker>
                        <mat-icon matPrefix class="text-gray-400 mr-2">event_busy</mat-icon>
                    </mat-form-field>

                    <!-- Budget -->
                    <mat-form-field appearance="outline" class="w-full">
                        <mat-label>Budget (€)</mat-label>
                        <input matInput type="number" formControlName="budget" min="0">
                        <mat-icon matPrefix class="text-gray-400 mr-2">euro_symbol</mat-icon>
                        <span matSuffix>€</span>
                    </mat-form-field>
                </div>
            </div>

            <!-- Actions - sticky footer -->
            <div class="sticky bottom-0 left-0 right-0 p-4 bg-white border-t mt-8 flex justify-end gap-4">
                <button mat-stroked-button type="button" mat-dialog-close class="px-6">
                    <mat-icon>close</mat-icon>
                    Annuler
                </button>
                <button mat-raised-button color="primary" type="submit" [disabled]="missionForm.invalid" class="px-6">
                    <mat-icon>{{ editMode ? 'save' : 'add' }}</mat-icon>
                    {{ editMode ? 'Mettre à jour' : 'Créer' }}
                </button>
            </div>
        </form>
    </div>
</ng-template>